#!/usr/bin/env bash
cat <<EOF
port-migrate: Reinstall MacPorts and all ports.

Use this script after upgrading to a new version of OS X.
See <https://trac.macports.org/wiki/Migration>

WARNING: ALL PORTS WILL BE REINSTALLED.
EOF

if [ y_or_n "Continue?" ]; then
    echo aborted.
    exit 1
fi
cd

# Reinstall MacPorts.
echo --> Reinstalling MacPorts base system...
curl -O https://distfiles.macports.org/MacPorts/MacPorts-2.2.0.tar.bz2
tar xf MacPorts-2.2.0.tar.bz2
(
    cd MacPorts-2.2.0
    ./configure
    make && make install
)

# Save list of ports.
echo --> Writing ports list to ~/ports.txt
port -qv installed > ports.txt

# Uninstall all ports.
echo --> Uninstalling all ports...
port -f uninstall installed

# Clean any partially-completed builds.
echo --> Cleaning...
port clean all

# Restore ports.
echo --> Reinstalling ports...
curl -O \
    https://svn.macports.org/repository/macports/contrib/restore_ports/restore_ports.tcl
chmod +x restore_ports.tcl

if ./restore_ports.tcl ~/ports.txt; then
    rm ./restore_ports.tcl
else
    cat <<EOF

Restoring ports failed.

You must install the ports you want manually. See ~/ports.txt for a list of
ports that were previously installed.

EOF
    exit 1
fi

# Local Variables:
# mode: sh
# End:
